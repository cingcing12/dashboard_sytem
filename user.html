<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>គ្រប់គ្រងអ្នកប្រើប្រាស់ - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        /* Using a wider, more accessible font stack */
        @import url('https://fonts.googleapis.com/css2?family=Khmer+OS+Battambang:wght@400;600;700&display=swap');
        body { font-family: 'Khmer OS Battambang', sans-serif; min-height: 100vh; }
        
        /* Custom scrollbar for better look (still hiding the main one) */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Modal improvements */
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(44, 62, 80, 0.85); /* Darker, professional overlay */
            justify-content: center; 
            align-items: center; 
            z-index: 50; 
            backdrop-filter: blur(4px); /* Modern blur effect */
        }
        .modal.active { display:flex; }
        
        /* Custom Shadow for the main card */
        .card-shadow { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08); }
        
        /* Custom focus for input fields */
        input:focus, select:focus {
            outline: 2px solid #6b46c1; /* Purple focus ring */
            border-color: #6b46c1;
        }

        /* SweetAlert2 Khmer Customization - Add custom styles if needed */
        /* .swal2-popup { font-family: 'Khmer OS Battambang', sans-serif; } */
    </style>
</head>
<body class="bg-gray-50">

<header class="bg-white shadow-lg p-4 sticky top-0 z-10 border-b-2 border-purple-100">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
        <h1 class="text-3xl font-extrabold text-purple-700 flex items-center">
            <i data-lucide="shield-check" class="w-7 h-7 mr-3 text-purple-600"></i> គ្រប់គ្រងអ្នកប្រើប្រាស់
        </h1>
        <button onclick="window.location.href='dashboard.html'" class="bg-blue-600 text-white p-3 px-6 rounded-xl font-semibold hover:bg-blue-700 transition duration-200 flex items-center shadow-md">
            <span class="hidden sm:inline mr-2">ផ្ទាំងគ្រប់គ្រង</span>
            <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
        </button>
    </div>
</header>

<main class="max-w-7xl mx-auto p-4 md:p-8">
    <section class="bg-white p-6 rounded-2xl card-shadow mb-8 border-t-8 border-purple-600">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 sm:mb-0">បញ្ជីគណនី</h2>
            <button onclick="openModal()" class="bg-purple-600 text-white px-5 py-3 rounded-xl flex items-center font-semibold hover:bg-purple-700 transition duration-200 shadow-lg">
                <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i> បង្កើតគណនីថ្មី
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[70vh] overflow-y-auto hide-scrollbar" id="user-list">
            <p class="col-span-full text-center text-gray-500 py-10 text-lg">កំពុងទាញទិន្នន័យ...</p>
        </div>
    </section>
</main>

<div id="userModal" class="modal">
    <div class="bg-white rounded-2xl p-8 w-full max-w-lg relative shadow-2xl transform transition-all scale-100">
        <h3 id="modalTitle" class="text-2xl font-bold text-purple-700 mb-6 border-b pb-2">បន្ថែមអ្នកប្រើថ្មី</h3>
        
        <form id="modalForm">
            <div class="mb-4">
                <label for="modalEmail" class="block text-gray-700 font-medium mb-2">អាសយដ្ឋានអ៊ីម៉ែល</label>
                <input id="modalEmail" type="email" placeholder="បញ្ចូលអ៊ីម៉ែល" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition" required>
            </div>
            
            <div class="mb-4">
                <label for="modalPassword" class="block text-gray-700 font-medium mb-2">ពាក្យសម្ងាត់ថ្មី</label>
                <input id="modalPassword" type="password" placeholder="បញ្ចូលពាក្យសម្ងាត់" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition" required>
            </div>
            
            <div class="mb-6">
                <label for="modalRole" class="block text-gray-700 font-medium mb-2">តួនាទី (Role)</label>
                <select id="modalRole" class="w-full p-4 border border-gray-300 rounded-lg appearance-none focus:ring-purple-500 focus:border-purple-500 transition">
                    <option value="Admin">Admin (អ្នកគ្រប់គ្រង)</option>
                    <option value="Owner">Owner (ម្ចាស់)</option>
                    <option value="Staff">Staff (បុគ្គលិក)</option>
                </select>
            </div>
        
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" onclick="closeModal()" class="px-6 py-3 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition">បោះបង់</button>
                <button type="submit" id="modalSaveBtn" class="px-6 py-3 bg-purple-600 text-white font-semibold rounded-xl hover:bg-purple-700 transition duration-200 shadow-md">រក្សាទុកទិន្នន័យ</button>
            </div>
        </form>
        
        <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100 transition">
            <i data-lucide="x" class="w-6 h-6"></i>
        </button>
    </div>
</div>

<script src="config.js"></script>
<script>
let editingUserEmail = null;

// Function to handle showing nice alerts
function showSwal(icon, title, text) {
    Swal.fire({
        icon: icon,
        title: title,
        text: text,
        confirmButtonText: 'យល់ព្រម',
        confirmButtonColor: '#6b46c1', // Tailwind purple-600
        customClass: {
            popup: 'font-khmer' // Custom class if needed
        }
    });
}

function openModal(user = null) {
    const modal = document.getElementById('userModal');
    const emailInput = document.getElementById('modalEmail');
    const passwordInput = document.getElementById('modalPassword');
    const roleSelect = document.getElementById('modalRole');
    const form = document.getElementById('modalForm');
    
    // Reset form and form validation state
    form.reset();
    document.getElementById('modalSaveBtn').textContent = "រក្សាទុកទិន្នន័យ";

    if(user) {
        editingUserEmail = user.Email;
        document.getElementById('modalTitle').textContent = "កែប្រែគណនីអ្នកប្រើ";
        emailInput.value = user.Email;
        emailInput.disabled = true; 
        emailInput.classList.add('bg-gray-100'); 
        passwordInput.value = ''; 
        passwordInput.placeholder = "បញ្ចូលពាក្យសម្ងាត់ថ្មី បើចង់ផ្លាស់ប្តូរ (ទុកចោលបើមិនផ្លាស់ប្តូរ)";
        passwordInput.removeAttribute('required'); // Password is not required on edit
        roleSelect.value = user.Role;
    } else {
        editingUserEmail = null;
        document.getElementById('modalTitle').textContent = "បង្កើតគណនីថ្មី";
        emailInput.value = "";
        emailInput.disabled = false;
        emailInput.classList.remove('bg-gray-100');
        passwordInput.value = "";
        passwordInput.placeholder = "ពាក្យសម្ងាត់សម្រាប់គណនីថ្មី";
        passwordInput.setAttribute('required', 'required'); // Password is required on create
        roleSelect.value = "Staff"; 
    }
    modal.classList.add('active');
}

function closeModal() {
    document.getElementById('userModal').classList.remove('active');
    document.getElementById('modalForm').reset(); 
}

// Load users
async function loadUsers() {
    const list = document.getElementById("user-list");
    list.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10 text-lg flex items-center justify-center"><i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-3"></i> កំពុងទាញទិន្នន័យ...</p>';
    lucide.createIcons();

    try {
        // Ensure SHEET_USERS and SHEETDB_BASE_URL are defined in config.js
        if (typeof sheetUrl === 'undefined' || typeof SHEET_USERS === 'undefined') {
            throw new Error("Missing config.js definitions (sheetUrl, SHEET_USERS).");
        }
        
        const res = await fetch(sheetUrl(SHEET_USERS));
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        
        const data = await res.json();
        const users = data.slice(1); // start from row 3 (assuming row 1 and 2 are headers)

        if (users.length === 0) {
            list.innerHTML = '<p class="col-span-full text-center text-gray-500 py-10 text-xl border-dashed border-2 border-gray-300 rounded-lg m-4">⚠️ មិនមានគណនីអ្នកប្រើប្រាស់ទេ។ សូមចុច "បង្កើតគណនីថ្មី"។</p>';
            return;
        }

        list.innerHTML = users.map(u => {
            const isBlocked = u.IsBlocked === "TRUE";
            const blockBtnText = isBlocked ? 'ដោះ Block' : 'ដាក់ Block';
            const blockBtnIcon = isBlocked ? 'unlock' : 'lock';
            const blockBtnColor = isBlocked ? 'bg-green-500 hover:bg-green-600' : 'bg-yellow-500 hover:bg-yellow-600';
            const statusText = isBlocked ? 'ទប់ស្កាត់' : 'សកម្ម';
            const statusColor = isBlocked ? 'text-red-600 bg-red-100' : 'text-green-600 bg-green-100';
            const roleColor = u.Role === 'Owner' ? 'bg-pink-600' : (u.Role === 'Admin' ? 'bg-indigo-600' : 'bg-purple-600');
            
            return `
                <div class="user-card bg-white p-5 rounded-xl shadow-lg border-l-4 ${isBlocked ? 'border-red-500' : 'border-purple-500'} transition hover:shadow-xl">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <p class="text-lg font-bold text-gray-800 break-words">${u.Email}</p>
                            <span class="text-sm font-semibold px-2 py-0.5 rounded-full ${statusColor}">${statusText}</span>
                        </div>
                        <span class="text-sm font-bold text-white px-3 py-1 rounded-full ${roleColor}">${u.Role}</span>
                    </div>

                    <div class="text-xs text-gray-500 mb-4 border-t pt-2 mt-2">
                        <p>ចូលចុងក្រោយ: ${u.LastLogin || 'មិនធ្លាប់'}</p>
                    </div>

                    <div class="flex space-x-2 pt-2 border-t">
                        <button onclick='openModal(${JSON.stringify(u)})' class="flex-1 bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-blue-600 transition flex items-center justify-center">
                            <i data-lucide="square-pen" class="w-4 h-4 mr-1"></i> កែប្រែ
                        </button>
                        <button onclick="toggleBlockSwal('${u.Email}', '${u.IsBlocked}')" class="flex-1 text-white px-3 py-2 rounded-lg text-sm font-semibold transition flex items-center justify-center ${blockBtnColor}">
                            <i data-lucide="${blockBtnIcon}" class="w-4 h-4 mr-1"></i> ${blockBtnText}
                        </button>
                        <button onclick="deleteUserSwal('${u.Email}')" class="flex-1 bg-red-500 text-white px-3 py-2 rounded-lg text-sm font-semibold hover:bg-red-600 transition flex items-center justify-center">
                            <i data-lucide="trash-2" class="w-4 h-4 mr-1"></i> លុប
                        </button>
                    </div>
                </div>
            `;
        }).join("");
        
        lucide.createIcons();

    } catch (error) {
        list.innerHTML = '<p class="col-span-full text-center text-red-500 py-10 text-lg">❌ មានបញ្ហាក្នុងការទាញទិន្នន័យ។ សូមពិនិត្យមើល Console។</p>';
        console.error("Error loading users:", error);
    }
}

// Save user (Add or Edit) - attached to form submit for better UX
document.getElementById('modalForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const modalSaveBtn = document.getElementById('modalSaveBtn');
    modalSaveBtn.disabled = true;
    modalSaveBtn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-5 h-5 mr-2"></i> កំពុងរក្សាទុក...';
    lucide.createIcons();

    const email = document.getElementById('modalEmail').value.trim();
    const password = document.getElementById('modalPassword').value.trim();
    const role = document.getElementById('modalRole').value;

    try {
        if(editingUserEmail) {
            // Edit user
            const updateData = { Role: role };
            if (password) {
                updateData.PasswordHash = password;
            }

            const res = await fetch(`${SHEETDB_BASE_URL}/Email/${encodeURIComponent(editingUserEmail)}`, {
                method:"PATCH",
                headers:{"Content-Type":"application/json"},
                body: JSON.stringify({data:[updateData]})
            });
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

            showSwal('success', 'កែប្រែបានជោគជ័យ!', `គណនី ${email} ត្រូវបានកែប្រែដោយជោគជ័យ។`);

        } else {
            // Add user
            if(!password) {
                showSwal('warning', 'ទិន្នន័យមិនពេញលេញ', "សូមបញ្ចូលពាក្យសម្ងាត់សម្រាប់គណនីថ្មី!");
                return; // Stop execution
            }
            
            const res = await fetch(sheetUrl(SHEET_USERS), {
                method:"POST",
                headers:{"Content-Type":"application/json"},
                body: JSON.stringify({data:[{Email:email,PasswordHash:password,Role:role,IsBlocked:"FALSE",LastLogin:""}]})
            });
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

            showSwal('success', 'បង្កើតបានជោគជ័យ!', `គណនី ${email} ត្រូវបានបង្កើតដោយជោគជ័យ។`);
        }

        closeModal();
        loadUsers();

    } catch (error) {
        showSwal('error', 'មានបញ្ហាក្នុងការរក្សាទុក', `មិនអាចរក្សាទុកទិន្នន័យបានទេ។ ${error.message}`);
        console.error("Error saving user:", error);
    } finally {
        modalSaveBtn.disabled = false;
        modalSaveBtn.textContent = "រក្សាទុកទិន្នន័យ";
    }
});


// Block/unblock user with SweetAlert2
async function toggleBlockSwal(email, currentStatus){
    const isBlocked = currentStatus === "TRUE";
    const action = isBlocked ? "ដោះ Block" : "ដាក់ Block";
    const newStatus = isBlocked ? "FALSE" : "TRUE";
    const newStatusText = isBlocked ? "សកម្ម" : "ទប់ស្កាត់";
    const icon = isBlocked ? 'question' : 'warning';
    const confirmButtonColor = isBlocked ? '#10b981' : '#f59e0b'; // green/yellow

    const result = await Swal.fire({
        title: `តើអ្នកប្រាកដថាចង់ ${action} គណនីនេះទេ?`,
        text: `គណនី ${email} នឹងត្រូវប្តូរទៅជា "${newStatusText}"។`,
        icon: icon,
        showCancelButton: true,
        confirmButtonColor: confirmButtonColor,
        cancelButtonColor: '#6c757d', // gray
        confirmButtonText: action,
        cancelButtonText: 'បោះបង់',
        customClass: {
            popup: 'font-khmer'
        }
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch(`${SHEETDB_BASE_URL}/Email/${encodeURIComponent(email)}`, {
                method:"PATCH",
                headers:{"Content-Type":"application/json"},
                body:JSON.stringify({data:[{IsBlocked:newStatus}]})
            });
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            
            showSwal('success', 'បានធ្វើបច្ចុប្បន្នភាព!', `គណនី ${email} ត្រូវបាន${action}ដោយជោគជ័យ!`);
            loadUsers();
        } catch (error) {
            showSwal('error', 'មានបញ្ហា!', `មិនអាច${action}គណនី ${email} បានទេ។`);
            console.error("Error toggling block status:", error);
        }
    }
}

// Delete user with SweetAlert2
async function deleteUserSwal(email){
    const result = await Swal.fire({
        title: 'តើអ្នកប្រាកដជាចង់លុបទេ?',
        text: `គណនី ${email} នឹងត្រូវលុបចេញពីប្រព័ន្ធទាំងស្រុង។ អ្នកមិនអាចយកវាមកវិញបានទេ។`,
        icon: 'error',
        showCancelButton: true,
        confirmButtonColor: '#dc3545', // red
        cancelButtonColor: '#6c757d', // gray
        confirmButtonText: 'ត្រូវហើយ! លុបវាចោល',
        cancelButtonText: 'បោះបង់',
        customClass: {
            popup: 'font-khmer'
        }
    });

    if (result.isConfirmed) {
        try {
            const res = await fetch(`${SHEETDB_BASE_URL}/Email/${encodeURIComponent(email)}`,{
                method:"DELETE"
            });
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            
            showSwal('success', 'បានលុបដោយជោគជ័យ!', `គណនី ${email} ត្រូវបានលុបចេញពីប្រព័ន្ធដោយជោគជ័យ។`);
            loadUsers();
        } catch (error) {
            showSwal('error', 'មានបញ្ហា!', `មិនអាចលុបគណនី ${email} បានទេ។`);
            console.error("Error deleting user:", error);
        }
    }
}

// Initialize
loadUsers();

// For icons in the header and initial load
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();
});
</script>

</body>
</html>